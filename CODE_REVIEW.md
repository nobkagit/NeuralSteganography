# Code Review Notes

## Overview
این یادداشت نتایج بازبینی اولیهٔ کد برای ماژول‌های اصلی رمزنگاری و ابزارهای مشترک پروژه را جمع‌بندی می‌کند. تمرکز بر ریسک‌های پایداری، قابلیت نگه‌داری و انطباق با استانداردهای تعریف‌شده در مخزن است.

## یافته‌های کلیدی
### 1. گلوگاه در تعیین `k` هنگام گرد کردن بازهٔ حسابی
- در توابع `encode_arithmetic` و `decode_arithmetic` مقداردهی `k` با استفاده از `(probs_temp < cur_threshold).nonzero()[0].item()` انجام می‌شود. اگر هیچ احتمالی کمتر از آستانه نباشد، این عبارت خطای index ایجاد می‌کند و کل فرآیند را متوقف می‌سازد. لازم است قبل از دسترسی، طول نتیجه بررسی شود یا مقدار پیش‌فرض امنی در نظر گرفته شود.【F:arithmetic.py†L7-L109】【F:arithmetic.py†L129-L268】

### 2. وابستگی پیش‌فرض به CUDA
- تقریباً تمام مسیرهای encode/decode پارامتر `device` را `'cuda'` مقداردهی اولیه کرده‌اند. این پیش‌فرض در محیط‌های فاقد GPU باعث شکست سریع اجرا می‌شود، در حالی‌که بیشتر منطق قابلیت اجرا روی CPU را دارد. پیشنهاد می‌شود به‌جای مقدار ثابت، مقدار پیش‌فرض بر اساس `torch.cuda.is_available()` انتخاب شود.【F:arithmetic.py†L7-L127】【F:block_baseline.py†L26-L189】

### 3. مونکی‌پچ کردن توکنایزر ترنسفورمر
- در `utils.py` توابع `AutoTokenizer.decode` و `_convert_token_to_id` بازنویسی شده‌اند. این تغییر سراسری برای تمام نمونه‌های توکنایزر اعمال می‌شود و می‌تواند با نسخه‌های آیندهٔ Transformers یا سایر بخش‌های کد در تعارض باشد. بهتر است Wrapper محلی یا زیرکلاس ایجاد شود تا از اثرات جانبی سراسری جلوگیری گردد.【F:utils.py†L7-L57】

### 4. seed زدن CUDA حتی در نبود GPU
- تابع `get_model` صرف‌نظر از دسترسی به GPU، `torch.cuda.manual_seed` را فراخوانی می‌کند. در محیط‌های CPU-only این فراخوانی استثناء ایجاد می‌کند. شرطی‌سازی این فراخوانی بر اساس `torch.cuda.is_available()` توصیه می‌شود.【F:utils.py†L72-L88】

### 5. نبود type hints و docstring
- توابع هسته‌ای فاقد anotations و مستندسازی هستند، در حالی‌که استانداردهای مخزن استفادهٔ اجباری از typing و docstring دقیق را الزام کرده‌اند. افزودن تایپ و توضیحات می‌تواند خوانایی و ابزارهای تحلیلی (mypy/ruff) را بهبود دهد.【F:arithmetic.py†L7-L127】【F:block_baseline.py†L26-L189】【F:utils.py†L7-L114】

## پیشنهادهای بعدی
1. افزودن کنترل خطا و مقدار پیش‌فرض امن برای تعیین `k` در الگوریتم حسابی.
2. انتخاب خودکار دستگاه (CPU/GPU) و امکان override با پارامتر کاربر.
3. حذف مونکی‌پچ جهانی و ایجاد wrapper توکنایزر با رفتار سفارشی.
4. شرطی کردن seed زدن CUDA به در دسترس بودن آن.
5. مستندسازی و تایپ‌گذاری توابع اصلی مطابق دستورالعمل پروژه.
